# 📘 **SPECIFICATION.md — テニスコート予約アプリ仕様書（v1.3）**

更新日：2025-12-22

作成者：T Yossy

---

# 1. **概要**

本アプリは、テニスコートの予約管理にとどまらず、チームや個人がどれだけ、
何の練習をしたかを記録・可視化できるプラットフォームである。
予約に伴う参加表明や抽選期間リマインド機能を備え、Google Sheets ベースの
データ管理を行う。Streamlitで構築され、カレンダー形式とリスト形式での表示
切り替えが可能で、チームの調整業務を自動化・簡素化すると同時に、
週単位・月単位・個人別の練習統計を提供し管理者の把握や個人のモチベーション
向上にも貢献することを目的とする。

---

# 2. **目的**

* **バージョン管理の重要性**
  * 顧客毎にカスタマイズや拡張を行う可能性があるため、
    アプリ本体および仕様は明確なバージョン管理を行う。
  * 異なる顧客・環境で枝分かれするブランチを維持する場合にも
    バージョン番号を元に互換性やリリース履歴を追跡できるようにする。
  * バージョン番号は `MAJOR.MINOR.PATCH` 形式とし、
    主要機能追加時にMAJORを、後方互換の追加/修正でMINORを、
    バグ修正や細かな変更でPATCHを増分する。


* テニスコートの予約調整を効率化し、情報の抜け漏れを防ぐ
* チームメンバーの参加状況を一元管理する
* どれくらい、どんな練習を行ったかを週単位・月単位・個人別に集計・可視化し、
  管理者が状況を把握したり、メンバーのモチベーションを高める
* 抽選期間の開始・終了を自動的に案内し、毎月の競争を防ぐ
* 入力補助により、誤記・名称ゆれを防止しメンテナンス性を高める
* Google Drive / Google Sheets を活用し、クラウド環境で安全に管理する

---


## **バージョン管理方針**

* アプリ本体と仕様は `MAJOR.MINOR.PATCH` の形式でバージョン番号を付与。
* リリースごとに `APP_VERSION` 定数とドキュメント上のバージョンを合わせる。
* 顧客によって機能や挙動が分岐する場合はブランチ戦略を採用し、
  各ブランチに固有のバージョン番号(例: 1.0.0-custA)を付ける。
* バージョン番号は顧客へのリリース履歴管理、互換性判定、
  バグ報告時の環境特定に活用する。
* 古いバージョンを維持する場合でも、ドキュメント・コード内に
  どのバージョンが有効か明示しメンテナンスコストを抑える。

# 3. **全体機能一覧**

| 機能カテゴリ       | 内容                                                                        |
| ------------------ | --------------------------------------------------------------------------- |
| 予約管理（CRUD）   | 日付・時間帯・施設名・コート種類・定員・メッセージ登録/編集/削除、完了自動化  |
| 定員管理           | 参加表明時に定員チェック、定員到達で自動的にステータスを「締切」に変更      |
| 参加表明           | 参加/保留/削除 の選択、参加者一覧表示              |
| 実績確認           | グループおよび個人の週/月単位練習回数・時間をグラフ化、個人選択で相関分析可能 |
| 抽選期間リマインド | 毎月/毎週/毎年 の繰り返し設定、固定文言メッセージ複数登録、トップに常時表示 |
| オートコンプリート | 施設名、ニックネーム候補の入力補助、過去履歴から推奨候補生成                |
| カレンダー表示     | 月間カレンダー、予約状況色分け（募集中/締切/抽選中/中止/完了）               |
| Google Drive 連携  | Sheetsへの読み書き、複数シート（reservations / facilities / lottery_periods）管理 |
| 施設情報表示       | 施設名のハイパーリンク化、住所表示                                       |
| Googleカレンダー連携 | 予約情報を個人カレンダーに登録するURL生成機能                              |

---

# 4. **データ定義（Google Sheets）**

---

## 4.1 **reservations シート**

| カラム名     | 型           | 内容                             |
| ------------ | ------------ | -------------------------------- |
| date         | date         | 開始日                           |
| facility     | string       | 施設名                           |
| court_type   | string       | コート種類（オムニ / クレー / ハード / インドア / 不明） |

| status       | string       | 募集中 / 締切 / 抽選中 / 中止 / 完了 |
| start_hour   | integer      | 開始時（0-23）                   |
| start_minute | integer      | 開始分（0-59）                   |
| end_hour     | integer      | 終了時（0-23）                   |
| end_minute   | integer      | 終了分（0-59）                   |
| capacity     | integer/null | 定員（null=指定なし）            |
| participants | list[string] | 参加者一覧（;区切り保存）        |
| consider     | list[string] | 検討中一覧（;区切り保存）        |
| message      | string       | メッセージ（改行は`<br>`変換） |

---

## 4.2 **facilities シート（施設マスタ）**

| カラム名 | 型     | 内容                           |
| -------- | ------ | ------------------------------ |
| name     | string | 施設名（一意）                 |
| url      | string | 公式サイトURL（任意）          |
| address  | string | 住所（任意）                   |

### ● 運用ルール

* 施設名は重複不可（予約時の選択肢として使用）
* **新規予約登録時、施設名がfacilitiesシートに存在しない場合、自動的に追加される**
* URLと住所は管理者がfacilitiesシートで手作業で追記
* URLが設定されている場合、予約詳細画面で施設名がハイパーリンクとして表示される
* 住所が設定されている場合、予約詳細画面で施設名の下に表示される

---

## 4.3 **lottery_periods シート（抽選期間リマインド）**

| カラム名    | 型            | 内容                          |
| ----------- | ------------- | ----------------------------- |
| id          | string        | 一意識別子（UUID等）          |
| title       | string        | 抽選・お知らせ内容名          |
| enabled     | string        | 有効フラグ（true/false）      |
| frequency   | string        | monthly / weekly / yearly     |
| start_month | int / null    | yearly：開始月（1-12）        |
| start_day   | int / null    | yearly/monthly：開始日        |
| end_month   | int / null    | yearly：終了月（1-12）        |
| end_day     | int / null    | yearly/monthly：終了日        |
| weekdays    | string / null | weekly：対象曜日（Mon,Thu等） |
| messages    | string        | 表示メッセージ                |

---

# 5. **画面構成**

| 画面エリア               | 内容                                                                                          |
| :----------------------- | :-------------------------------------------------------------------------------------------- |
| **ヘッダー**       | アプリタイトル「🎾 テニスコート予約管理」                           |
| **メイン表示切替** | **「📅 カレンダー」 / 「📋 予約リスト」 / 「📈 実績確認」 のタブ切り替え**                                |
| **カレンダータブ** | streamlit-calendarによる月表示。日付クリックで新規登録、イベントクリックで編集画面。イベント表示時は施設名とコート種類をそれぞれ明示。          |
| **リストタブ**     | DataFrameによる表形式表示。「過去の予約も表示する」チェックボックス付き。行選択で編集画面。表示カラムには施設名に加えてコート種類を含める。   |
| **実績確認タブ**   | 予約データを元に実績を集計・表示する。現状はプレースホルダで、後続機能のためにタブを準備。 |
| **詳細・編集画面** | **@st.dialogによるポップアップ表示。** 画面遷移なしで登録・編集・削除・参加表明を行う。 |

# 6. **機能詳細仕様**

---

## 6.1 **予約管理（CRUD）**

### ● 新規登録

* 施設名：過去履歴からのselectbox + 新規入力オプション
* コート種類：ドロップダウン（オムニ / クレー / ハード / インドア / 不明、デフォルト：オムニ）
  * 過去データに値が無い場合は自動的に「不明」に設定される。
* ステータス：**募集中または抽選中のみ選択可能**（デフォルト：募集中）
  * 管理者が後から変更することで締切・完了・中止にできるが、
    登録時には設定できない。
* 時間：time_inputで30分刻み（デフォルト：9:00-11:00）
* 定員：ドロップダウンから「指定なし」または「1～30」を選択（デフォルト：指定なし）
* メッセージ：text_area（改行は`<br>`に変換して保存）
* 【今後対応】締切日時やその他管理者向け情報は登録時には入力不可

### ● 定員管理ルール

* 定員を指定した場合、参加者数（参加のみ、保留は除外）がその数に達したら自動的にステータスを「締切」に変更
* 「締切」ステータスの予約に対して新規相談者の参加表明を試みると「定員に達しています」エラーを表示
* 参加者の削除により定員以下になった場合、自動的にステータスを「募集中」に戻す

### ● 編集

* 基本情報表示（日時・施設・コート種類・ステータス・定員・参加状況・メモ）
* 参加表明：名前選択 + 参加/保留/削除の選択（定員チェック付き）
* 管理者メニュー：メモ編集・ステータス変更・定員変更・削除機能

### ● 削除

* 管理者メニュー内の削除タブから実行
* DataFrameから該当行を削除してreset_index

---

## 6.2 **参加表明機能**

* 表明は **参加 / 保留 / 削除 の3種**
* 名前は過去履歴からのselectbox + 新規入力オプション
* 各リスト（participants/consider）から重複削除して追加
* 参加者・保留者一覧を「なし」または「, 」区切りで表示

### ● タブ切り替え制御

* タブ切り替え時にlist_reset_counterをインクリメント
* 月移動時も強制リセットでポップアップを閉じる

### ● ポップアップ制御（@st.dialog）

* **フラグ制御:** is_popup_open, popup_mode, last_click_signatureで状態管理
* **重複防止:** 同じクリックでの重複実行を防止
* **CSS調整:** ポップアップの位置・スクロール動作を最適化
* **自動リセット:** 月移動やタブ切り替えで自動的にポップアップを閉じる

## 6.3 **実績確認機能**

* グループ全体の月単位練習回数および練習時間を集計し、表または**棒グラフで表示**。実装初期段階では表形式で合計を示す。
* 個人別集計やグラフ表示は将来的な拡張とし、現在はグループ全体のみを対象とする。
* 選択した個人の上達具合（例: 参加頻度や練習時間の増減）を可視化し、練習との相関を分析。
* 将来的にはコート種別やメニュー別のフィルタリング、練習成果の定量評価等にも対応予定。

## 6.4 **抽選期間リマインド機能**

### ● 表示条件判定

* **enabled列チェック:** "true", "1", "yes", "有効"の場合のみ処理
* **JST時刻:** UTC+9時間で日本時刻に変換
* **条件分岐:**
  * monthly: start_day ≤ 今日の日 ≤ end_day
  * weekly: 今日の曜日が weekdays に含まれる
  * yearly: 年をまたぐ期間も考慮した日付範囲チェック

### ● 表示仕様

* st.expander()で折りたたみ表示、デフォルト非表示
* st.info()で "🔔 {メッセージ}" 形式
* 複数該当時は複数表示
* アプリ起動時に自動チェック

## 6.5 **パフォーマンス最適化**

### ● キャッシュ戦略

* **@st.cache_data(ttl=15):** 予約データを15秒キャッシュ
* **@st.cache_data(ttl=3600):** リマインダーデータを1時間キャッシュ
* **@st.cache_resource:** Google Sheets接続をセッション間で共有

### ● リトライ処理

* **run_with_retry関数:** 最大5回リトライ
* **APIエラー対応:** 429/5xx系エラーで指数バックオフ
* **例外処理:** 一般例外は2秒待機後リトライ

---

## 6.6 **入力補助機能**

### ● 施設名補助

* 過去のfacility列から重複除去したリストを生成
* selectboxで "(施設名を選択)" + 過去履歴 + "新規登録" の選択肢
* "新規登録" 選択時にtext_inputを表示

### ● 名前補助

* participants/consider列から全ての名前を収集
* ";" 区切りの文字列も分割して処理
* 重複除去・ソート後にselectboxの選択肢として提供

---

## 6.7 **Google Sheets連携**

### ● 認証方式

* **Service Account認証:** st.secrets["google"]から認証情報取得
* **スコープ:** "https://www.googleapis.com/auth/spreadsheets"
* **接続:** gspread.authorize()でクライアント作成

### ● データ操作

* **読み取り:** get_all_records()で全データ取得
* **書き込み:** clear() + update()で全データ置換
* **データ変換:**
  * リスト → ";" 区切り文字列（保存時）
  * ";" 区切り文字列 → リスト（読み込み時）
  * 日付 → ISO形式文字列（保存時）

---

## 6.8 **施設情報表示機能**

### ● 施設マスタ連携

* **facilitiesシートから施設情報を取得**
* **予約登録時、施設名がfacilitiesシートに存在しない場合、自動的に追加**
  * 初期状態: name=施設名、url=""、address=""
  * URLと住所は管理者が後からGoogle Sheetsで手作業追記
* 予約詳細画面で施設名を表示する際、以下の情報を付加
  * URLが設定されている場合: 施設名をハイパーリンク化
  * 住所が設定されている場合: 施設名の下に住所を表示

### ● 表示例

**URLありの場合:**
```
施設: ○○テニスコート ↗️
     （施設名がリンクになっており、クリックで公式サイトへ）
住所: 東京都渋谷区...
```

**URLなしの場合:**
```
施設: ○○テニスコート
住所: 東京都渋谷区...
```

### ● 実装方法

* URLがある場合: `<a href="{url}" target="_blank">{施設名} ↗️</a>`
* URLがない場合: 施設名をそのまま表示
* 住所は通常テキストとして表示

---

# 7. **予約ステータスと色定義**

| ステータス | 色 | 説明           |
| ---------- | -- | -------------- |
| 募集中     | 緑 | 参加者募集中   |
| 締切       | 緑 | 定員に達した   |
| 抽選中     | 黄 | 抽選申請中     |
| 中止       | 灰 | 実施なし       |
| 完了       | 灰 | 過去の予約     |

---

# 8. **UI/UX仕様**

### ● CSS カスタマイズ

* **ポップアップ位置:** 上詰め配置（align-items: flex-start）
* **スクロール制御:** 背景スクロール防止（overscroll-behavior: contain）
* **余白調整:** アプリ全体の上部余白を最小化

### ● レスポンシブ対応

* **スマホ誤操作防止:** longPressDelay: 400ms
* **カラム幅調整:** st.column_configで各列の表示幅を最適化
* **タッチ操作:** streamlit-calendarのタッチイベント対応

---

# 9. **Googleカレンダー連携機能**

## 9.1 **概要**

予約情報をユーザーの個人Googleカレンダーに登録できる機能。

**目的:**
* テニス予約をGoogleカレンダーに登録することで、スマホのカレンダーアプリで一元管理
* 他の予定（仕事、プライベート等）と同じカレンダー上で表示されるため、スケジュール重複を視覚的に確認できる
* スマホの標準カレンダーアプリで予約を確認できるため、アプリを開かなくても予定を把握可能

## 9.2 **実装方式**

### ● OAuth不要の簡易実装

* **方式:** GoogleカレンダーのURL生成機能を使用
* **メリット:** OAuth認証不要、実装が簡単、セキュリティリスクが低い
* **デメリット:** 自動登録ではなく、ユーザーが最終確認して保存

### ● URL形式

```
https://calendar.google.com/calendar/render?action=TEMPLATE
&text=[タイトル]
&dates=[開始日時]/[終了日時]
&ctz=Asia/Tokyo
```

## 9.3 **登録される情報**

### ● イベントタイトル

```
🎾テニス_[施設名]
```
例: `🎾テニス_○○テニスコート`

### ● 日時

* 開始: 予約の開始日時（YYYYMMDDTHHMMSS形式）
* 終了: 予約の終了日時（YYYYMMDDTHHMMSS形式）
* タイムゾーン: Asia/Tokyo (JST)

## 9.4 **UI配置**

* 予約詳細ポップアップ（編集モード）内、日時表示の下に「カレンダーに追加」のリンク文字列を表示
* リンクをクリックすると新しいタブ/ウィンドウでGoogleカレンダーの予定作成画面を開く
* 実装: `st.markdown`でHTMLリンクを生成
* 参考: テニスベアアプリのUI/UXを参考にしたデザイン

## 9.5 **実装関数**

```python
def generate_google_calendar_url(reservation_data):
    """
    予約データからGoogleカレンダー登録用URLを生成
    
    Args:
        reservation_data: 予約情報の辞書
        
    Returns:
        str: Googleカレンダー登録用URL
    """
```

## 9.6 **注意事項**

* 登録は手動確認が必要（完全自動ではない）
* 予約情報が更新されても、Googleカレンダー側は自動更新されない
* 重複登録の防止機能はない（ユーザーが管理）
* URLパラメータには施設名、日時のみを含む（個人情報は含まない）

---

# 10. **技術的制約・注意事項**

### ● Google Sheets API制限

* **レート制限:** 100 requests/100 seconds/user
* **対策:** リトライ処理 + キャッシュによる呼び出し削減

### ● データ整合性

* **型変換:** safe_int()関数で安全な数値変換
* **日付処理:** to_jst_date()でタイムゾーン統一
* **リスト処理:** 空文字・None値の適切な処理

### ● セッション状態管理

* **フラグ制御:** is_popup_open, popup_mode等で画面状態を管理
* **重複防止:** last_click_signatureで同一操作の重複実行を防止
* **自動リセット:** 月移動・タブ切り替え時の状態初期化

---

# 11. **更新履歴**

| 日付       | 内容                                                       | 担当    |
| ---------- | ---------------------------------------------------------- | ------- |
| 2025-11-18 | v1.2更新（抽選期間、参加コメント、オートコンプリート統合） | T Yossy |
| 2025-12-22 | v1.3実装に基づく仕様書の正確な更新                         | T Yossy |
| 2025-XX-XX | v1.4 Googleカレンダー連携機能の仕様追加                    | T Yossy |
| 2025-XX-XX | v1.5 施設情報表示機能（URLリンク、住所表示）の仕様追加 | T Yossy |
